#!/bin/bash
# Error trapping first
#---------------------
set -o errexit

trap 'trap_handler ${?} ${LINENO} ${0}' ERR
trap 'exit_handler ${?}' EXIT
#---------------------

# Enable debug output
#--------------------
PS4='+ [$(date --rfc-3339=seconds)] '
set -o xtrace
#--------------------

# This file is generated by Nodepool while building snapshots
# It contains credentials to access RabbitMQ and an OpenStack lab
source ~/credentials

# Basic parameters
#-----------------
STACK_HOME='/opt/stack'

ZUUL_URL=${ZUUL_URL:-'https://git.openstack.org'}
ZUUL_REF=${ZUUL_REF:-'master'}
ZUUL_PROJECT=${ZUUL_PROJECT:-'openstack/murano'}

if [[ -n "${OVERRIDE_BRANCH}" ]]; then
    ZUUL_BRANCH=$OVERRIDE_BRANCH
    ZUUL_REF=$OVERRIDE_BRANCH
fi

if [[ -n "${OVERRIDE_URL}" ]]; then
    ZUUL_URL=$OVERRIDE_URL
fi

if [[ -n "${OVERRIDE_PROJECT}" ]]; then
    ZUUL_PROJECT=$OVERRIDE_PROJECT
fi

EXECUTE_TESTS_BY_TAG=${EXECUTE_TESTS_BY_TAG:-''}

APPS_REPO=${APPS_REPO:-https://github.com/openstack/murano-apps}
APPS_BRANCH=${APPS_BRANCH:-master}
APPS_REPOSITORY_URL=${APPS_REPOSITORY_URL:-http://storage.apps.openstack.org/}

DIB_MURANO_AGENT_REPO=${DIB_MURANO_AGENT_REPO:-git://git.openstack.org/openstack/murano-agent.git}
DIB_MURANO_AGENT_BRANCH=${DIB_MURANO_AGENT_BRANCH:-master}
DIB_MURANO_AGENT_REF=${DIB_MURANO_AGENT_REF:-''}

MURANO_REPO=${MURANO_REPO:-git://git.openstack.org/openstack/murano.git}
MURANO_BRANCH=${ZUUL_BRANCH}

MURANO_DASHBOARD_REPO=${MURANO_DASHBOARD_REPO:-git://git.openstack.org/openstack/murano-dashboard.git}
MURANO_DASHBOARD_BRANCH=${ZUUL_BRANCH}

MURANO_PYTHONCLIENT_REPO=${MURANO_PYTHONCLIENT_REPO:-git://git.openstack.org/openstack/python-muranoclient.git}
MURANO_PYTHONCLIENT_BRANCH=${ZUUL_BRANCH}

PROJECT_NAME=${ZUUL_PROJECT##*/}

APT_PROXY_HOST=${APT_PROXY_HOST:-''}

OPENSTACK_HOST=${OPENSTACK_HOST:-$KEYSTONE_URL}

WITH_COVERAGE=${WITH_COVERAGE:-'false'}

DO_NOT_COLLECT_ARTIFACTS=${DO_NOT_COLLECT_ARTIFACTS:-false}

WORKSPACE=$(cd $WORKSPACE && pwd)

TZ_STRING='Europe/Moscow'

DISTR_NAME=${DISTR_NAME:-'ubuntu'}

LINUX_IMAGE=${DISTR_NAME}_latest

# Commands used in script
#------------------------
NOSETESTS_CMD=$(which nosetests)
#------------------------

# Virtual framebuffer settings
#-----------------------------
VFB_DISPLAY_SIZE='1280x1024'
VFB_COLOR_DEPTH=16
VFB_DISPLAY_NUM=22
#-----------------------------

case "${PROJECT_NAME}" in
    'murano')
        PROJECT_DIR="${STACK_HOME}/murano"
        PROJECT_TESTS_DIR="${PROJECT_DIR}/murano/tests/functional"
    ;;
    'murano-dashboard')
        PROJECT_DIR="${STACK_HOME}/murano-dashboard"
        PROJECT_TESTS_DIR="${PROJECT_DIR}/muranodashboard/tests/functional"
    ;;
    'python-muranoclient')
        PROJECT_DIR="${STACK_HOME}/python-muranoclient"
        PROJECT_TESTS_DIR="${STACK_HOME}/murano-dashboard/muranodashboard/tests/functional"
    ;;
    'murano-agent')
        PROJECT_TESTS_DIR="${STACK_HOME}/murano/murano/tests/functional"
        export DIB_MURANO_AGENT_REPO="${ZUUL_URL}/${ZUUL_PROJECT}"
        export DIB_MURANO_AGENT_BRANCH=${ZUUL_BRANCH}
        export DIB_MURANO_AGENT_REF=${ZUUL_REF}
    ;;
    'murano-apps')
        echo "No tests currently available"
    ;;
    *)
        echo "Project name '$ZUUL_PROJECT' isn't supported yet."
        exit 1
    ;;
esac

source ${WORKSPACE}/scripts/functions.inc

get_os

get_ip_from_iface eth0

get_floating_ip
